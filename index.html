<!DOCTYPE html>
<html>
<head>
  <title>Контент-план</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .calendar-container {
      margin-bottom: 20px;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.2rem;
    }

    .calendar-table td, .calendar-table th {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      position: relative; 
    }

    .calendar-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .current-day {
      background-color: #f0f0f0;
      cursor: pointer;
      background-image: linear-gradient(to bottom right, #f0f0f0, #f0f0f0);
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .time-form {
      margin-top: 20px;
      display: none; 
    }

    .time-table {
      border-collapse: collapse;
      width: 100%;
    }

    .time-table td, .time-table th {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .time-table th {
      background-color: #f2f2f2;
    }

    .time-slot {
      cursor: pointer;
    }

    .time-slot.selected {
      background-color: #f0f0f0;
    }

    .time-input {
      width: 80px; 
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      margin-right: 10px;
    }

    .time-input.invalid {
      border-color: red;
    }

    .time-entry {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .time-entry .type-select, 
    .time-entry .template-select {
      margin-left: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      width: 300px; 
    }

    .time-entry .text-input {
      flex: 1; 
      margin-left: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      resize: vertical;
      height: 180px; 
      width: calc(100% - 220px);
    }

    .time-and-type {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .selected-day {
      background-color: lightgreen;
    }

    .past-day {
      background-color: #ddd; 
      cursor: default; 
    }
    .content-count {
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-size: 12px;
      color: green;
    }

    .delete-button {
      margin-left: 10px;
      background-color: #dc3545; /* Красный цвет для кнопки "Удалить" */
      border: none;
      color: white;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-button:hover {
      background-color: #c82333;
    }

    @media (max-width: 768px) {
      .calendar-container {
        margin-bottom: 10px;
      }
      .calendar-table td, .calendar-table th {
        padding: 8px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <h2 class="text-center">Контент-план</h2>
        <div id="calendar" class="text-center"></div>
        <button id="nextMonthBtn" class="btn btn-primary">Следующий месяц</button>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="time-form">
          <h3>Выберите время и введите текст:</h3>
          <div id="timeEntries"></div>
          <button id="add-entry-button" class="btn btn-primary">Добавить запись</button>
          <button id="save-button" class="btn btn-primary">Сохранить</button>
        </div>
      </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      let tg = window.Telegram.WebApp;
      tg.expand();

      const calendarContainer = document.getElementById("calendar");
      const nextMonthBtn = document.getElementById("nextMonthBtn");
      const timeForm = document.querySelector('.time-form');
      const saveButton = document.getElementById('save-button');
      const addEntryButton = document.getElementById('add-entry-button');
      const timeEntriesContainer = document.getElementById('timeEntries');

      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let selectedDate = null;
      let userTemplates = [];

      // Получаем user_id из Telegram API
      // const userId = tg.initDataUnsafe.user.id; 
      const userId = 1; 

      calendarContainer.appendChild(generateCalendar(currentMonth, currentYear));

      nextMonthBtn.addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        calendarContainer.innerHTML = '';
        calendarContainer.appendChild(generateCalendar(currentMonth, currentYear));
      });

      // Функция для получения шаблонов пользователя
      function fetchUserTemplates() {
        return fetch(`http://localhost:8082/user-templates?userId=${userId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Ошибка при получении шаблонов пользователя');
            }
            return response.json();
          })
          .then(templates => {
            userTemplates = templates;
          })
          .catch(error => {
            console.error("Ошибка при получении шаблонов пользователя:", error);
          });
      }

      // Вызываем функцию для получения шаблонов при загрузке страницы
      fetchUserTemplates(); 

      function generateCalendar(month, year) {
        const monthNames = [
          "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
          "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
        ];

        const calendarTable = document.createElement("table");
        calendarTable.classList.add("calendar-table", "fade-in", "table", "table-bordered");

        const headerRow = calendarTable.insertRow();
        const headerCell = headerRow.insertCell();
        headerCell.colSpan = 7;
        headerCell.innerHTML = monthNames[month] + " " + year;

        const daysOfWeek = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
        const daysRow = calendarTable.insertRow();
        daysOfWeek.forEach(day => {
          const dayCell = daysRow.insertCell();
          dayCell.innerHTML = day;
        });

        let firstDay = (new Date(year, month)).getDay() - 1;
        if (firstDay === -1) {
          firstDay = 6;
        }

        const daysInMonth = 32 - new Date(year, month, 32).getDate();

        const today = new Date();
        const currentDay = today.getDate();
        const currentMonthNumber = today.getMonth();

        let date = 1;
        let contentData = null;
          
        fetchContentCount(month, year)
          .then(data => {
          contentData = data;

          for (let i = 0; i < 6; i++) {
            const row = calendarTable.insertRow();
            for (let j = 0; j < 7; j++) {
              const cell = row.insertCell();

              if (i === 0 && j < firstDay) {
                cell.innerHTML = "";
              } else if (date > daysInMonth) {
                break;
              } else {
                const fullDate = new Date(year, month, date);
                cell.dataset.date = `${year}-${month + 1}-${date}`;
                cell.innerHTML = date;
                cell.addEventListener('click', showTimeSelector);
                  
                if (fullDate < today) {
                  cell.classList.add("past-day");
                  cell.removeEventListener('click', showTimeSelector); // Делаем ячейку неактивной
                }

                if (date === currentDay && month === currentMonthNumber && year === today.getFullYear()) {
                  cell.classList.remove("past-day");
                  cell.addEventListener('click', showTimeSelector);
                }

                if (contentData) {
                  const contentForDate = contentData.find(item => item.date === cell.dataset.date);
                  if (contentForDate) {
                    const contentCount = document.createElement('span');
                    contentCount.classList.add('content-count');
                    contentCount.textContent = contentForDate.count;
                    cell.appendChild(contentCount);
                  }
                }

                date++;
              }
            }
          }
          })
          .catch(error => {
          console.error("Ошибка при получении количества заполненных шаблонов:", error);
          });

        return calendarTable;
      }

      function showTimeSelector(event) {
        event.preventDefault();
        const clickedDate = event.target.dataset.date;
        selectedDate = new Date(clickedDate);

        const selectedDays = document.querySelectorAll('.selected-day');
        selectedDays.forEach(day => day.classList.remove('selected-day'));

        event.target.classList.add('selected-day');

        console.log("Выбранная дата:", selectedDate);

        timeForm.style.display = "block";
        timeEntriesContainer.innerHTML = ''; // Очищаем контейнер перед загрузкой данных

        fetch(`http://localhost:8082/content?date=${selectedDate.toISOString().split('T')[0]}`)
          .then(response => response.json())
          .then(data => {
            data.forEach((entry, index) => {
              console.log(entry);
              addTimeEntry(entry.time, entry.type, entry.text, entry.id, entry.templateId, entry.imageUrl); // Передаем id записи и templateId в функцию
            });
          })
          .catch(error => {
            console.error("Ошибка при получении данных:", error);
          });
      }

      function fetchContentCount(month, year) {
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const firstMonthValue = firstDayOfMonth.toISOString().split('T')[0];
        const lastMonthValue = lastDayOfMonth.toISOString().split('T')[0];

        return fetch(`http://localhost:8082/content-count?date=${firstMonthValue}&endDate=${lastMonthValue}`)
          .then(response => response.json())
          .catch(error => {
          console.error("Ошибка при получении количества заполненных шаблонов:", error);
          throw error; 
          });
      }
        
      function addTimeEntry(time = '', type = 'Уточнить детали', text = '', id = null, templateId = null, imageUrl = '') {
        const timeEntryDiv = document.createElement('div');
        timeEntryDiv.classList.add('time-entry');

        const timeInput = document.createElement('input');
        timeInput.classList.add('time-input');
        timeInput.type = 'text';
        timeInput.placeholder = 'HH:mm';
        timeInput.addEventListener('input', validateTimeInput);
        timeInput.addEventListener('input', addColon);

        const textInput = document.createElement('textarea');
        textInput.classList.add('text-input');
        textInput.placeholder = 'Введите текст';
        textInput.value = text;

        const imageUrlInput = document.createElement('textarea');
        imageUrlInput.classList.add('image-url-input');
        imageUrlInput.placeholder = 'URL изображения';
        imageUrlInput.value = imageUrl;
        // Если запись пришла с сервера (id не пустой), отображаем только время и текст
        if (id) {
          timeEntryDiv.dataset.id = id;

          timeInput.value = time;

          timeEntryDiv.appendChild(timeInput);
          timeEntryDiv.appendChild(imageUrlInput); 
          timeEntryDiv.appendChild(textInput);
        } else { 
          // Если это новая запись, добавляем поля для времени, типа, шаблона и текста
          const typeSelect = document.createElement('select');
          typeSelect.classList.add('type-select');
          typeSelect.innerHTML = `
            <option value="Уточнить детали" ${type === 'Уточнить детали' ? 'selected' : ''}>Уточнить детали</option>
            <option value="Отредактировать готовый пост" ${type === 'Отредактировать готовый пост' ? 'selected' : ''}>Отредактировать готовый пост</option>
            <option value="Сгенерировать пост без деталей" ${type === 'Сгенерировать пост без деталей' ? 'selected' : ''}>Сгенерировать пост без деталей</option>
          `;

          const templateSelect = document.createElement('select');
          templateSelect.classList.add('template-select');
          // Заполняем options из userTemplates
          let templateOptions = '<option value="">Выберите шаблон</option>';
          userTemplates.forEach(template => {
            templateOptions += `<option value="${template.id}" ${template.id === templateId ? 'selected' : ''}>${template.shortName}</option>`;
          });
          templateSelect.innerHTML = templateOptions;

          const generateImageCheckbox = document.createElement('input');
          generateImageCheckbox.type = 'checkbox';
          generateImageCheckbox.id = `generateImage-${id || Math.random().toString(36).substring(2)}`; // Уникальный ID для чекбокса

          const generateImageLabel = document.createElement('label');
          generateImageLabel.htmlFor = generateImageCheckbox.id;
          generateImageLabel.textContent = 'Сгенерировать изображение';          

          timeEntryDiv.appendChild(timeInput);
          timeEntryDiv.appendChild(generateImageCheckbox);
          timeEntryDiv.appendChild(generateImageLabel);
          timeEntryDiv.appendChild(typeSelect);
          timeEntryDiv.appendChild(templateSelect); // Добавляем выбор шаблона
          timeEntryDiv.appendChild(textInput);
        }

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-button');
        deleteButton.textContent = 'Удалить запись';
        deleteButton.addEventListener('click', () => {
          // ... Логика удаления записи ...
          timeEntryDiv.remove();
        });
        timeEntryDiv.appendChild(deleteButton);

        timeEntriesContainer.appendChild(timeEntryDiv);
      }

      function validateTimeInput(event) {
        const input = event.target;
        const timeRegex = /^([01][0-9]|2[0-3]):[0-5][0-9]$/;

        if (timeRegex.test(input.value)) {
          input.classList.remove('invalid');
        } else {
          input.classList.add('invalid');
        }
      }

      function addColon(event) {
        const input = event.target;
        if (input.value.length === 2) {
          input.value += ':';
        }
      }

      addEntryButton.addEventListener('click', addTimeEntry);

      // Сохранение внесенных данных
      saveButton.addEventListener('click', () => {
        const timeEntries = timeEntriesContainer.querySelectorAll('.time-entry');
        const data = [];

        timeEntries.forEach(entry => {
          const timeInput = entry.querySelector('.time-input');
          const typeSelect = entry.querySelector('.type-select');
          const templateSelect = entry.querySelector('.template-select'); // Получаем выбранный шаблон
          const textInput = entry.querySelector('.text-input');
          const imageUrlInput = entry.querySelector('.image-url-input'); 
          const generateImageCheckbox = entry.querySelector('input[type="checkbox"]'); // Находим чекбокс

          const [hours, minutes] = timeInput.value.split(':');
          const entryData = {
            id: entry.dataset.id ? entry.dataset.id : null, //есть только для поста, котоырй уже сгенерирован сервером
            imageUrl: imageUrlInput ? imageUrlInput.value : null, //есть только для поста, котоырй уже сгенерирован сервером
            date: selectedDate.toISOString().split('T')[0], 
            time: `${hours}:${minutes}`,
            text: textInput.value,
            type: typeSelect ? typeSelect.value : null,
            templateId: templateSelect ? templateSelect.value : null,
            generateImage: generateImageCheckbox ? generateImageCheckbox.checked : false
          };

          data.push(entryData);
        });

        console.log('Данные для сохранения:', data);

        fetch(`http://localhost:8082/content`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json'
         },
         body: JSON.stringify(data)
        })
        .then(response => {
         if (!response.ok) {
           throw new Error('Ошибка при отправке данных на сервер');
         }
         console.log('Данные успешно отправлены на сервер');
         return response.json(); 
        })
        .then(data => {
         console.log('Ответ от сервера:', data);
         // После успешного сохранения можно обновить данные в DOM, 
         // например, перезагрузить список записей для выбранной даты.
        })
        .catch(error => {
         console.error('Произошла ошибка:', error);
        });

        timeForm.style.display = "none";
        const selectedDays = document.querySelectorAll('.selected-day');
        selectedDays.forEach(day => day.classList.remove('selected-day'));
      });
    </script>
  </div>
</body>
</html>